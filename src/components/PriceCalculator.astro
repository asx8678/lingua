---
// Kalkulator opiera się na liczbach z cennika 2025/2026.
// Uwaga: Jeżeli rozliczenie w Twoim przypadku wygląda inaczej (np. niestandardowa liczba spotkań),
// wynik traktuj jako orientacyjny i skontaktuj się ze szkołą.

const DATA = {
  packages: [
    {
      id: "pakiet-60",
      label: "Pakiet — 60 min",
      minutes: 60,
      baseSessions: 10,
      pricePerPerson: { 1: 1300, 2: 800, 3: 650 },
    },
    {
      id: "pakiet-45",
      label: "Pakiet — 45 min",
      minutes: 45,
      baseSessions: 10,
      pricePerPerson: { 1: 1000, 2: 600, 3: 500 },
    },
  ],
  courses: [
    {
      id: "kurs-2700",
      label: "Kurs — 30 × 90 min",
      price: 2700,
      sessions: 30,
      minutes: 90,
      minPersons: 3,
    },
    {
      id: "kurs-2800",
      label: "Kurs — 56 × 60 min",
      price: 2800,
      sessions: 56,
      minutes: 60,
      minPersons: 4,
    },
    {
      id: "kurs-4200",
      label: "Kurs — 56 × 90 min",
      price: 4200,
      sessions: 56,
      minutes: 90,
      minPersons: 4,
    },
  ],
};
---

<div class="card p-6">
  <div id="price-calc" class="grid gap-5">
    <!-- Typ zajęć -->
    <div>
      <div class="text-sm font-bold text-slate-900 mb-2">Typ zajęć</div>
      <div class="flex flex-wrap gap-2" id="plan-buttons">
        {DATA.packages.map((p, i) => (
          <button
            type="button"
            data-plan={p.id}
            class:list={[
              "plan-btn px-4 py-2 text-sm font-medium rounded-xl border-2 transition-all",
              i === 0 ? "border-primary bg-primary text-white" : "border-slate-200 bg-white text-slate-700 hover:border-slate-300"
            ]}
          >
            {p.label}
          </button>
        ))}
        {DATA.courses.map((c) => (
          <button
            type="button"
            data-plan={c.id}
            class="plan-btn px-4 py-2 text-sm font-medium rounded-xl border-2 border-slate-200 bg-white text-slate-700 hover:border-slate-300 transition-all"
          >
            {c.label}
          </button>
        ))}
      </div>
    </div>

    <!-- Liczba osób -->
    <div>
      <div class="text-sm font-bold text-slate-900 mb-2">Liczba osób</div>
      <div class="flex flex-wrap gap-2" id="persons-buttons">
        <!-- Buttons will be generated by JS based on plan type -->
      </div>
    </div>

    <!-- Liczba spotkań (tylko dla pakietów) -->
    <div id="sessions-row">
      <div class="text-sm font-bold text-slate-900 mb-2">Liczba spotkań</div>
      <div class="flex flex-wrap gap-2" id="sessions-buttons">
        <button type="button" data-sessions="10" class="session-btn px-4 py-2 text-sm font-medium rounded-xl border-2 border-primary bg-primary text-white transition-all">10</button>
        <button type="button" data-sessions="20" class="session-btn px-4 py-2 text-sm font-medium rounded-xl border-2 border-slate-200 bg-white text-slate-700 hover:border-slate-300 transition-all">20</button>
        <button type="button" data-sessions="30" class="session-btn px-4 py-2 text-sm font-medium rounded-xl border-2 border-slate-200 bg-white text-slate-700 hover:border-slate-300 transition-all">30</button>
        <button type="button" data-sessions="40" class="session-btn px-4 py-2 text-sm font-medium rounded-xl border-2 border-slate-200 bg-white text-slate-700 hover:border-slate-300 transition-all">40</button>
        <button type="button" data-sessions="50" class="session-btn px-4 py-2 text-sm font-medium rounded-xl border-2 border-slate-200 bg-white text-slate-700 hover:border-slate-300 transition-all">50</button>
      </div>
    </div>
  </div>

  <!-- Wyniki -->
  <div class="mt-6 rounded-2xl border border-slate-200 bg-slate-50 p-5">
    <div class="grid gap-4 sm:grid-cols-3 sm:items-end">
      <div>
        <div class="text-xs font-bold uppercase tracking-widest text-slate-500">Za spotkanie / osoba</div>
        <div id="out-per-session" class="mt-2 text-3xl font-extrabold text-slate-900">—</div>
        <div id="out-per-session-sub" class="mt-1 text-xs text-slate-500"></div>
      </div>

      <div>
        <div class="text-xs font-bold uppercase tracking-widest text-slate-500">Łącznie / osoba</div>
        <div id="out-per-total" class="mt-2 text-3xl font-extrabold text-slate-900">—</div>
        <div id="out-per-total-sub" class="mt-1 text-xs text-slate-500"></div>
      </div>

      <div id="total-block" class="hidden">
        <div class="text-xs font-bold uppercase tracking-widest text-slate-500">Łącznie (grupa)</div>
        <div id="out-total" class="mt-2 text-3xl font-extrabold text-slate-900">—</div>
        <div id="out-total-sub" class="mt-1 text-xs text-slate-500"></div>
      </div>
    </div>

    <div class="mt-4 flex items-center gap-2 text-xs text-slate-600">
      <input
        id="show-total"
        type="checkbox"
        class="h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary"
      />
      <label for="show-total" class="select-none cursor-pointer">Pokaż koszt dla całej grupy</label>
    </div>

    <div id="out-note" class="mt-4 text-xs text-slate-600"></div>
  </div>

  <p class="mt-4 text-xs text-slate-500">
    Kalkulator bazuje na cenniku 2025/2026. W przypadku kursów liczba spotkań jest stała.
  </p>

  <script type="application/json" id="price-data" set:html={JSON.stringify(DATA)}></script>
  <script is:inline>
    const DATA = JSON.parse(document.getElementById('price-data').textContent);

    // State
    let selectedPlan = "pakiet-60";
    let selectedPersons = 1;
    let selectedSessions = 10;

    // Elements
    const planButtonsContainer = document.getElementById("plan-buttons");
    const personsButtonsContainer = document.getElementById("persons-buttons");
    const sessionsButtonsContainer = document.getElementById("sessions-buttons");
    const sessionsRow = document.getElementById("sessions-row");
    const showTotalEl = document.getElementById("show-total");
    const totalBlockEl = document.getElementById("total-block");

    const outPerSessionEl = document.getElementById("out-per-session");
    const outPerSessionSubEl = document.getElementById("out-per-session-sub");
    const outPerTotalEl = document.getElementById("out-per-total");
    const outPerTotalSubEl = document.getElementById("out-per-total-sub");
    const outTotalEl = document.getElementById("out-total");
    const outTotalSubEl = document.getElementById("out-total-sub");
    const outNoteEl = document.getElementById("out-note");

    const fmt = new Intl.NumberFormat("pl-PL", { maximumFractionDigits: 0 });
    const pln = (v) => `${fmt.format(Math.round(v))} zł`;

    const getPlan = (id) => {
      const p = DATA.packages.find((x) => x.id === id);
      if (p) return { kind: "package", ...p };
      const c = DATA.courses.find((x) => x.id === id);
      if (c) return { kind: "course", ...c };
      return null;
    };

    function setText(el, txt) {
      if (el) el.textContent = txt;
    }

    function setActiveButton(container, activeValue, dataAttr) {
      container.querySelectorAll("button").forEach(btn => {
        const isActive = btn.dataset[dataAttr] === String(activeValue);
        btn.classList.toggle("border-primary", isActive);
        btn.classList.toggle("bg-primary", isActive);
        btn.classList.toggle("text-white", isActive);
        btn.classList.toggle("border-slate-200", !isActive);
        btn.classList.toggle("bg-white", !isActive);
        btn.classList.toggle("text-slate-700", !isActive);
      });
    }

    function renderPersonsButtons() {
      const plan = getPlan(selectedPlan);
      if (!plan) return;

      let options = [];
      if (plan.kind === "package") {
        options = [
          { value: 1, label: "1 osoba" },
          { value: 2, label: "2 osoby" },
          { value: 3, label: "3 osoby" },
        ];
      } else {
        const min = plan.minPersons;
        options = [];
        for (let i = min; i <= min + 3; i++) {
          options.push({ value: i, label: `${i} osób` });
        }
      }

      // Adjust selectedPersons if needed
      const validValues = options.map(o => o.value);
      if (!validValues.includes(selectedPersons)) {
        selectedPersons = validValues[0];
      }

      personsButtonsContainer.innerHTML = options.map(opt => `
        <button
          type="button"
          data-persons="${opt.value}"
          class="person-btn px-4 py-2 text-sm font-medium rounded-xl border-2 transition-all ${
            opt.value === selectedPersons
              ? "border-primary bg-primary text-white"
              : "border-slate-200 bg-white text-slate-700 hover:border-slate-300"
          }"
        >${opt.label}</button>
      `).join("");

      // Add click handlers
      personsButtonsContainer.querySelectorAll(".person-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          selectedPersons = Number(btn.dataset.persons);
          setActiveButton(personsButtonsContainer, selectedPersons, "persons");
          update();
        });
      });
    }

    function update() {
      const plan = getPlan(selectedPlan);
      if (!plan) return;

      const showTotal = Boolean(showTotalEl?.checked);
      totalBlockEl?.classList.toggle("hidden", !showTotal);

      // Show/hide sessions row
      if (plan.kind === "course") {
        sessionsRow.classList.add("hidden");
        selectedSessions = plan.sessions;
      } else {
        sessionsRow.classList.remove("hidden");
      }

      // Reset outputs
      setText(outPerSessionEl, "—");
      setText(outPerSessionSubEl, "");
      setText(outPerTotalEl, "—");
      setText(outPerTotalSubEl, "");
      setText(outTotalEl, "—");
      setText(outTotalSubEl, "");
      setText(outNoteEl, "");

      const persons = selectedPersons;
      const sessions = selectedSessions;

      if (plan.kind === "course") {
        const perPersonTotal = plan.price;
        const perSession = plan.price / plan.sessions;
        const groupTotal = perPersonTotal * persons;

        setText(outPerSessionEl, pln(perSession));
        setText(outPerSessionSubEl, `${plan.minutes} min`);

        setText(outPerTotalEl, pln(perPersonTotal));
        setText(outPerTotalSubEl, `${plan.sessions} spotkań`);

        if (showTotal) {
          setText(outTotalEl, pln(groupTotal));
          setText(outTotalSubEl, `${persons} os.`);
        }

        setText(outNoteEl, `Kurs: ${plan.sessions} spotkań × ${plan.minutes} min. Cena z cennika.`);
      } else {
        const price10 = plan.pricePerPerson[String(persons)];
        const perSession = price10 / plan.baseSessions;
        const perPersonTotal = perSession * sessions;
        const groupTotal = perPersonTotal * persons;

        setText(outPerSessionEl, pln(perSession));
        setText(outPerSessionSubEl, `${plan.minutes} min`);

        setText(outPerTotalEl, pln(perPersonTotal));
        setText(outPerTotalSubEl, `${sessions} spotkań`);

        if (showTotal) {
          setText(outTotalEl, pln(groupTotal));
          setText(outTotalSubEl, `${persons} os.`);
        }

        const isMultiple = sessions % plan.baseSessions === 0;
        setText(
          outNoteEl,
          isMultiple
            ? `Pakiet ${plan.baseSessions} spotkań × ${plan.minutes} min: ${pln(price10)} / osoba.`
            : `Wyliczenie proporcjonalne do pakietu 10 spotkań (${pln(price10)}).`
        );
      }
    }

    // Plan button handlers
    planButtonsContainer.querySelectorAll(".plan-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        selectedPlan = btn.dataset.plan;
        setActiveButton(planButtonsContainer, selectedPlan, "plan");
        renderPersonsButtons();
        update();
      });
    });

    // Session button handlers
    sessionsButtonsContainer.querySelectorAll(".session-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        selectedSessions = Number(btn.dataset.sessions);
        setActiveButton(sessionsButtonsContainer, selectedSessions, "sessions");
        update();
      });
    });

    // Show total checkbox
    showTotalEl?.addEventListener("change", update);

    // Initial render
    renderPersonsButtons();
    update();
  </script>
</div>
