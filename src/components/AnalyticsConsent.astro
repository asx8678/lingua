---
/**
 * Analytics Consent Banner
 * GDPR-compliant consent dialog for Google Analytics
 */
import { ANALYTICS_ID, STORAGE_KEYS } from "../config/analytics";

interface Props {
  analyticsId?: string;
}

const { analyticsId = ANALYTICS_ID } = Astro.props;
const consentKey = STORAGE_KEYS.analyticsConsent;

// Tailwind class constants
const btnPrimary = "inline-flex items-center justify-center gap-2 rounded-full px-6 py-3 text-sm font-bold transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary bg-primary text-white shadow-md hover:bg-primary-700 hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 active:shadow-md";
const btnSecondary = "inline-flex items-center justify-center gap-2 rounded-full px-6 py-3 text-sm font-bold transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary border border-slate-200 bg-white text-slate-700 shadow-sm hover:border-primary/30 hover:text-primary hover:shadow-md hover:-translate-y-0.5 active:translate-y-0";
const btnGhost = "inline-flex items-center justify-center gap-2 rounded-full px-6 py-3 text-sm font-bold transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary bg-transparent text-slate-700 hover:bg-slate-100";
---

<div
  id="analytics-consent"
  class="fixed inset-x-0 bottom-20 z-50 hidden px-4 md:bottom-6"
  role="dialog"
  aria-modal="true"
  aria-hidden="true"
  aria-labelledby="analytics-consent-title"
  data-analytics-id={analyticsId}
  data-consent-key={consentKey}
>
  <div class="mx-auto max-w-3xl rounded-2xl border border-slate-200 bg-white p-4 shadow-soft">
    <p id="analytics-consent-title" class="text-sm font-bold text-slate-900">
      Pomóż nam ulepszać stronę
    </p>
    <p class="mt-2 text-sm text-slate-600">
      Używamy Google Analytics do statystyk ruchu. Zgodę możesz zmienić w każdej chwili w
      polityce prywatności.
    </p>
    <div class="mt-3 flex flex-wrap gap-3">
      <button id="analytics-consent-accept" class={btnPrimary} type="button">
        Akceptuj
      </button>
      <button id="analytics-consent-reject" class={btnSecondary} type="button">
        Odrzuć
      </button>
      <a class={btnGhost} href="/privacy">Polityka prywatności</a>
    </div>
  </div>
</div>

<script is:inline>
  (() => {
    const banner = document.getElementById("analytics-consent");
    if (!banner) return;

    const consentKey = banner.dataset.consentKey || "lingua-analytics-consent";
    const analyticsId = banner.dataset.analyticsId || "";
    const acceptBtn = document.getElementById("analytics-consent-accept");
    const rejectBtn = document.getElementById("analytics-consent-reject");

    const showBanner = () => {
      banner.classList.remove("hidden");
      banner.setAttribute("aria-hidden", "false");
      acceptBtn?.focus();
    };

    const hideBanner = () => {
      banner.classList.add("hidden");
      banner.setAttribute("aria-hidden", "true");
    };

    const getStoredConsent = () => {
      try {
        return localStorage.getItem(consentKey);
      } catch {
        return null;
      }
    };

    const setStoredConsent = (value) => {
      try {
        localStorage.setItem(consentKey, value);
      } catch {}
    };

    const ensurePreconnect = (href) => {
      if (document.querySelector(`link[rel="preconnect"][href="${href}"]`)) return;
      const link = document.createElement("link");
      link.rel = "preconnect";
      link.href = href;
      document.head.appendChild(link);
    };

    const loadAnalytics = () => {
      if (!analyticsId) return;
      if (window.__linguaAnalyticsLoaded) return;
      window.__linguaAnalyticsLoaded = true;

      ensurePreconnect("https://www.googletagmanager.com");
      ensurePreconnect("https://www.google-analytics.com");

      const script = document.createElement("script");
      script.async = true;
      script.src = `https://www.googletagmanager.com/gtag/js?id=${analyticsId}`;
      document.head.appendChild(script);

      window.dataLayer = window.dataLayer || [];
      function gtag() {
        window.dataLayer.push(arguments);
      }
      window.gtag = window.gtag || gtag;
      window.gtag("js", new Date());
      window.gtag("config", analyticsId);
    };

    const stored = getStoredConsent();
    if (stored === "granted") {
      loadAnalytics();
      hideBanner();
    } else if (stored === "denied") {
      hideBanner();
    } else {
      showBanner();
    }

    acceptBtn?.addEventListener("click", () => {
      setStoredConsent("granted");
      hideBanner();
      loadAnalytics();
    });

    rejectBtn?.addEventListener("click", () => {
      setStoredConsent("denied");
      hideBanner();
    });

    banner.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        setStoredConsent("denied");
        hideBanner();
      }
    });

    document.querySelectorAll("[data-analytics-consent-reset]").forEach((button) => {
      button.addEventListener("click", () => {
        try {
          localStorage.removeItem(consentKey);
        } catch {}
        location.reload();
      });
    });
  })();
</script>
