---
/**
 * Event Tracker Script
 * Handles analytics event tracking for clicks, forms, and phone calls
 */
import { STORAGE_KEYS, TRACK_CATEGORIES } from "../config/analytics";

const consentKey = STORAGE_KEYS.analyticsConsent;
---

<script is:inline define:vars={{ consentKey, TRACK_CATEGORIES }}>
  (() => {
    const trackedForms = new WeakSet();

    const hasConsent = () => {
      try {
        return localStorage.getItem(consentKey) === "granted";
      } catch {
        return false;
      }
    };

    const track = (eventName, params = {}) => {
      if (!hasConsent()) return;
      if (typeof window.gtag !== "function") return;
      window.gtag("event", eventName, params);
    };

    // Track clicks on elements with data-track attribute
    document.addEventListener("click", (event) => {
      const target = event.target.closest("[data-track]");
      if (target) {
        const eventName = target.dataset.track;
        if (!eventName) return;
        track(eventName, {
          event_category: target.dataset.trackCategory || TRACK_CATEGORIES.conversion,
          event_label: target.dataset.trackLabel || target.textContent?.trim() || "",
          link_url: target.getAttribute("href") || "",
        });
        return;
      }

      // Track primary button clicks
      const primaryBtn = event.target.closest(".btn-primary");
      if (primaryBtn) {
        track("cta_primary", {
          event_category: TRACK_CATEGORIES.conversion,
          event_label: primaryBtn.textContent?.trim() || "",
          link_url: primaryBtn.getAttribute("href") || "",
        });
        return;
      }

      // Track secondary button clicks
      const secondaryBtn = event.target.closest(".btn-secondary");
      if (secondaryBtn) {
        track("cta_secondary", {
          event_category: TRACK_CATEGORIES.conversion,
          event_label: secondaryBtn.textContent?.trim() || "",
          link_url: secondaryBtn.getAttribute("href") || "",
        });
      }
    });

    // Track phone link clicks
    document.addEventListener("click", (event) => {
      const link = event.target.closest('a[href^="tel:"]');
      if (!link) return;
      track("phone_click", {
        event_category: TRACK_CATEGORIES.conversion,
        event_label: link.textContent?.trim() || "Telefon",
        link_url: link.getAttribute("href") || "",
      });
    });

    // Track form starts (first field focus)
    document.addEventListener("focusin", (event) => {
      const form = event.target.closest("form[data-track-form]");
      if (!form || trackedForms.has(form)) return;
      trackedForms.add(form);
      track("form_start", {
        event_category: TRACK_CATEGORIES.engagement,
        form_id: form.dataset.trackForm || "",
      });
    });

    // Track form submissions
    document.addEventListener(
      "submit",
      (event) => {
        const form = event.target;
        if (!form?.matches?.("form[data-track-form]")) return;
        track("form_submit", {
          event_category: TRACK_CATEGORIES.conversion,
          form_id: form.dataset.trackForm || "",
        });
      },
      true
    );

    // Track outbound link clicks
    document.addEventListener("click", (event) => {
      const link = event.target.closest('a[href^="http"]');
      if (!link) return;
      const url = new URL(link.href);
      if (url.hostname === window.location.hostname) return;
      track("outbound_click", {
        event_category: TRACK_CATEGORIES.engagement,
        event_label: url.hostname,
        link_url: link.href,
      });
    });
  })();
</script>
