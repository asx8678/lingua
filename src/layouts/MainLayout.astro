---
import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import SeoHead from "../components/SeoHead.astro";
import MobileCTA from "../components/MobileCTA.astro";
import AnalyticsConsent from "../components/AnalyticsConsent.astro";
import EventTracker from "../components/EventTracker.astro";
import { subjects } from "../data/subjects";
import {
  SITE_URL,
  BRAND_NAME,
  DEFAULT_TITLE,
  DEFAULT_DESCRIPTION,
  CONTACT_EMAIL,
  CONTACT_PHONE,
  BUSINESS,
  ANALYTICS_ENABLED,
  isTodo,
} from "../config/site";

interface Props {
  title?: string;
  description?: string;
  canonical?: string;
  robots?: string;
  ogType?: string;
  ogImageAlt?: string;
  structuredData?: object[];
  /** Language attribute for the page content */
  lang?: string;
}

const {
  title = DEFAULT_TITLE,
  description = DEFAULT_DESCRIPTION,
  canonical,
  robots,
  ogType,
  ogImageAlt,
  structuredData = [],
  lang = "pl",
} = Astro.props;

const currentPath = Astro.url.pathname;
const canonicalUrl = canonical?.startsWith("http")
  ? canonical
  : new URL(canonical ?? currentPath, SITE_URL).toString();

const addressData = {
  "@type": "PostalAddress",
  streetAddress: BUSINESS.streetAddress || undefined,
  postalCode: BUSINESS.postalCode || undefined,
  addressLocality: BUSINESS.city || undefined,
  addressCountry: "PL",
};

const hasAddress = Boolean(BUSINESS.streetAddress || BUSINESS.postalCode || BUSINESS.city);
const hasGeo = Boolean(BUSINESS.geo.latitude && BUSINESS.geo.longitude);
const sameAs = Object.values(BUSINESS.social).filter(Boolean);

const orgJsonLd = {
  "@context": "https://schema.org",
  "@type": ["EducationalOrganization", "LanguageSchool", "LocalBusiness"],
  "@id": `${SITE_URL}/#organization`,
  name: BRAND_NAME,
  legalName: BUSINESS.legalEntityName || undefined,
  alternateName: ["Lingua Legionowo", "Angielski Legionowo"],
  url: SITE_URL,
  email: isTodo(CONTACT_EMAIL) ? undefined : CONTACT_EMAIL,
  telephone: isTodo(CONTACT_PHONE) ? undefined : CONTACT_PHONE,
  address: hasAddress ? addressData : undefined,
  geo: hasGeo
    ? {
        "@type": "GeoCoordinates",
        latitude: BUSINESS.geo.latitude,
        longitude: BUSINESS.geo.longitude,
      }
    : undefined,
  openingHours: BUSINESS.openingHours || undefined,
  sameAs: sameAs.length ? sameAs : undefined,
  areaServed: [
    {
      "@type": "City",
      name: BUSINESS.city || "Legionowo",
    },
    {
      "@type": "Country",
      name: "Polska",
      description: "Kursy online dostępne w całej Polsce",
    },
  ],
  description:
    "Szkoła języków obcych i matematyki w Legionowie. Zajęcia stacjonarne i online dla wszystkich poziomów.",
  priceRange: "$$",
  hasOfferCatalog: {
    "@type": "OfferCatalog",
    name: "Języki obce i matematyka",
    itemListElement: subjects.map((subject) => ({
      "@type": "Offer",
      itemOffered: {
        "@type": "Course",
        name: subject,
      },
    })),
  },
};

const websiteJsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "@id": `${SITE_URL}/#website`,
  name: BRAND_NAME,
  url: SITE_URL,
  inLanguage: "pl-PL",
};

const jsonLd = [orgJsonLd, websiteJsonLd, ...structuredData].filter(Boolean);
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="theme-color" content="#0052CC" />
    <meta name="color-scheme" content="light dark" />

    <SeoHead
      title={title}
      description={description}
      canonical={canonicalUrl}
      robots={robots}
      ogType={ogType}
      ogImageAlt={ogImageAlt || title}
    />
    <slot name="head" />

    <link rel="icon" href="/favicon.svg" />

    <script is:inline type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </head>
  <body class="flex min-h-screen flex-col bg-white text-slate-900 antialiased">
    <a href="#content" class="sr-only focus:not-sr-only focus:fixed focus:left-6 focus:top-6 focus:z-50 focus:rounded-full focus:bg-white focus:px-4 focus:py-2 focus:text-sm focus:font-bold focus:text-primary focus:shadow-soft">
      Przejdź do treści
    </a>

    <Header currentPath={currentPath} />
    <main id="content" class="flex-1 pb-28 md:pb-0" lang={lang}>
      <slot />
    </main>
    <Footer />

    <MobileCTA />

    {ANALYTICS_ENABLED && <AnalyticsConsent />}

    <EventTracker />
  </body>
</html>
