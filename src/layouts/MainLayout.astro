---
import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import SeoHead from "../components/SeoHead.astro";
import { subjects } from "../data/subjects";
import {
  SITE_URL,
  BRAND_NAME,
  DEFAULT_TITLE,
  DEFAULT_DESCRIPTION,
  CONTACT_EMAIL,
  CONTACT_PHONE,
  BUSINESS,
  ANALYTICS_ENABLED,
  ANALYTICS_ID,
  CTA_PRIMARY_LABEL,
  CTA_PRIMARY_HREF,
  isTodo,
} from "../config/site";

interface Props {
  title?: string;
  description?: string;
  canonical?: string;
  robots?: string;
  ogType?: string;
  ogImageAlt?: string;
  structuredData?: object[];
}

const {
  title = DEFAULT_TITLE,
  description = DEFAULT_DESCRIPTION,
  canonical,
  robots,
  ogType,
  ogImageAlt,
  structuredData = [],
} = Astro.props;

const currentPath = Astro.url.pathname;
const canonicalUrl = canonical?.startsWith("http")
  ? canonical
  : new URL(canonical ?? currentPath, SITE_URL).toString();

const addressData = {
  "@type": "PostalAddress",
  streetAddress: BUSINESS.streetAddress || undefined,
  postalCode: BUSINESS.postalCode || undefined,
  addressLocality: BUSINESS.city || undefined,
  addressCountry: "PL",
};

const hasAddress = Boolean(BUSINESS.streetAddress || BUSINESS.postalCode || BUSINESS.city);
const hasGeo = Boolean(BUSINESS.geo.latitude && BUSINESS.geo.longitude);
const sameAs = Object.values(BUSINESS.social).filter(Boolean);

const orgJsonLd = {
  "@context": "https://schema.org",
  "@type": ["EducationalOrganization", "LanguageSchool", "LocalBusiness"],
  "@id": `${SITE_URL}/#organization`,
  name: BRAND_NAME,
  legalName: BUSINESS.legalEntityName || undefined,
  alternateName: ["Lingua Legionowo", "Angielski Legionowo"],
  url: SITE_URL,
  email: isTodo(CONTACT_EMAIL) ? undefined : CONTACT_EMAIL,
  telephone: isTodo(CONTACT_PHONE) ? undefined : CONTACT_PHONE,
  address: hasAddress ? addressData : undefined,
  geo: hasGeo
    ? {
        "@type": "GeoCoordinates",
        latitude: BUSINESS.geo.latitude,
        longitude: BUSINESS.geo.longitude,
      }
    : undefined,
  openingHours: BUSINESS.openingHours || undefined,
  sameAs: sameAs.length ? sameAs : undefined,
  areaServed: {
    "@type": "City",
    name: BUSINESS.city || "Legionowo",
  },
  description:
    "Szkoła języków obcych i matematyki w Legionowie. Zajęcia stacjonarne i online dla wszystkich poziomów.",
  priceRange: "$$",
  hasOfferCatalog: {
    "@type": "OfferCatalog",
    name: "Języki obce i matematyka",
    itemListElement: subjects.map((subject) => ({
      "@type": "Offer",
      itemOffered: {
        "@type": "Course",
        name: subject,
      },
    })),
  },
};

const websiteJsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: BRAND_NAME,
  url: SITE_URL,
  inLanguage: "pl-PL",
};

const jsonLd = [orgJsonLd, websiteJsonLd, ...structuredData].filter(Boolean);
---

<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="theme-color" content="#0052CC" />

    <SeoHead
      title={title}
      description={description}
      canonical={canonicalUrl}
      robots={robots}
      ogType={ogType}
      ogImageAlt={ogImageAlt}
    />
    <slot name="head" />

    <link rel="icon" href="/favicon.svg" />

    <script is:inline type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </head>
  <body class="flex min-h-screen flex-col">
    <a
      href="#content"
      class="sr-only focus:not-sr-only focus:fixed focus:left-6 focus:top-6 focus:z-50 focus:rounded-full focus:bg-white focus:px-4 focus:py-2 focus:text-sm focus:font-bold focus:text-primary focus:shadow-soft"
    >
      Przejdź do treści
    </a>

    <Header currentPath={currentPath} />
    <main id="content" class="flex-1 pb-24 md:pb-0">
      <slot />
    </main>
    <Footer />

    <div
      class="fixed inset-x-0 bottom-0 z-40 border-t border-slate-200 bg-white/95 backdrop-blur md:hidden"
    >
      <div class="container-site py-3">
        <a class="btn btn-primary w-full" href={CTA_PRIMARY_HREF} aria-label={CTA_PRIMARY_LABEL}>
          {CTA_PRIMARY_LABEL}
        </a>
      </div>
    </div>

    {
      ANALYTICS_ENABLED && (
        <>
          <div
            id="analytics-consent"
            class="fixed inset-x-0 bottom-20 z-50 hidden px-4 md:bottom-6"
            role="dialog"
            aria-hidden="true"
            aria-labelledby="analytics-consent-title"
            data-analytics-id={ANALYTICS_ID}
          >
            <div class="mx-auto max-w-3xl rounded-2xl border border-slate-200 bg-white p-4 shadow-soft">
              <p id="analytics-consent-title" class="text-sm font-bold text-slate-900">
                Pomóż nam ulepszać stronę
              </p>
              <p class="mt-2 text-sm text-slate-600">
                Używamy Google Analytics do statystyk ruchu. Zgodę możesz zmienić w każdej chwili w
                polityce prywatności.
              </p>
              <div class="mt-3 flex flex-wrap gap-3">
                <button id="analytics-consent-accept" class="btn btn-primary" type="button">
                  Akceptuj
                </button>
                <button id="analytics-consent-reject" class="btn btn-secondary" type="button">
                  Odrzuć
                </button>
                <a class="btn btn-ghost" href="/privacy">Polityka prywatności</a>
              </div>
            </div>
          </div>

          <script is:inline>
            (() => {
              const consentKey = "lingua-analytics-consent";
              const banner = document.getElementById("analytics-consent");
              const analyticsId = banner?.dataset.analyticsId || "";
              const acceptBtn = document.getElementById("analytics-consent-accept");
              const rejectBtn = document.getElementById("analytics-consent-reject");

              const showBanner = () => {
                if (!banner) return;
                banner.classList.remove("hidden");
                banner.setAttribute("aria-hidden", "false");
              };

              const hideBanner = () => {
                if (!banner) return;
                banner.classList.add("hidden");
                banner.setAttribute("aria-hidden", "true");
              };

              const getStoredConsent = () => {
                try {
                  return localStorage.getItem(consentKey);
                } catch {
                  return null;
                }
              };

              const setStoredConsent = (value) => {
                try {
                  localStorage.setItem(consentKey, value);
                } catch {
                  // Ignore storage errors (private mode or blocked storage).
                }
              };

              const ensurePreconnect = (href) => {
                if (document.querySelector(`link[rel="preconnect"][href="${href}"]`)) return;
                const link = document.createElement("link");
                link.rel = "preconnect";
                link.href = href;
                document.head.appendChild(link);
              };

              const loadAnalytics = () => {
                if (!analyticsId) return;
                if (window.__linguaAnalyticsLoaded) return;
                window.__linguaAnalyticsLoaded = true;

                ensurePreconnect("https://www.googletagmanager.com");
                ensurePreconnect("https://www.google-analytics.com");

                const script = document.createElement("script");
                script.async = true;
                script.src = `https://www.googletagmanager.com/gtag/js?id=${analyticsId}`;
                document.head.appendChild(script);

                window.dataLayer = window.dataLayer || [];
                function gtag() {
                  window.dataLayer.push(arguments);
                }
                window.gtag = window.gtag || gtag;
                window.gtag("js", new Date());
                window.gtag("config", analyticsId);
              };

              const stored = getStoredConsent();
              if (stored === "granted") {
                loadAnalytics();
                hideBanner();
              } else if (stored === "denied") {
                hideBanner();
              } else {
                showBanner();
              }

              acceptBtn?.addEventListener("click", () => {
                setStoredConsent("granted");
                hideBanner();
                loadAnalytics();
              });

              rejectBtn?.addEventListener("click", () => {
                setStoredConsent("denied");
                hideBanner();
              });

              document.querySelectorAll("[data-analytics-consent-reset]").forEach((button) => {
                button.addEventListener("click", () => {
                  try {
                    localStorage.removeItem(consentKey);
                  } catch {
                    // Ignore storage errors.
                  }
                  location.reload();
                });
              });
            })();
          </script>
        </>
      )
    }
  </body>
</html>
