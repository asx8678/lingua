---
import MainLayout from "../../layouts/MainLayout.astro";
import { getCollection } from "astro:content";
import {
  BRAND_NAME,
  BRAND_TAGLINE,
  CTA_PRIMARY_HREF,
  CTA_PRIMARY_LABEL,
  SITE_URL,
  generateBreadcrumbSchema,
} from "../../config/site";

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts
    .filter((post) => !post.data.draft)
    .map((post) => ({ params: { slug: post.slug }, props: { post } }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();
const allPosts = await getCollection("blog");

const title = `${post.data.title} | ${BRAND_NAME}`;
const description = post.data.description;

const formatDate = (date: Date) =>
  new Intl.DateTimeFormat("pl-PL", { dateStyle: "medium" }).format(date);
const publishedDate = formatDate(post.data.pubDate);
const updatedDate = post.data.updatedDate ? formatDate(post.data.updatedDate) : null;

const tocHeadings = headings.filter((heading) => heading.depth === 2 || heading.depth === 3);
const hasToc = tocHeadings.length >= 3;

const tagContext = [post.slug, post.data.title, ...post.data.tags]
  .join(" ")
  .toLowerCase();
const prefersInPerson = tagContext.includes("stacjonarn");

const onlineOffer = {
  title: "Angielski online",
  href: "/angielski-online",
  description: "Lekcje na żywo z lektorem, elastyczne godziny i nacisk na mówienie.",
};
const inPersonOffer = {
  title: "Angielski stacjonarnie",
  href: "/angielski-stacjonarnie",
  description: "Zajęcia w Legionowie z pełnym wsparciem lektora i jasnym planem nauki.",
};

const primaryOffer = prefersInPerson ? inPersonOffer : onlineOffer;
const secondaryOffer = primaryOffer.href === inPersonOffer.href ? onlineOffer : inPersonOffer;

const currentTags = new Set(post.data.tags.map((tag) => tag.toLowerCase()));
const relatedPosts = allPosts
  .filter((item) => !item.data.draft && item.slug !== post.slug)
  .map((item) => ({
    post: item,
    score: item.data.tags.reduce(
      (total, tag) => total + (currentTags.has(tag.toLowerCase()) ? 1 : 0),
      0
    ),
  }))
  .sort(
    (a, b) =>
      b.score - a.score || b.post.data.pubDate.getTime() - a.post.data.pubDate.getTime()
  )
  .slice(0, 3)
  .map((item) => item.post);

const authorName = post.data.author ?? BRAND_NAME;
const authorRole = post.data.authorRole ?? BRAND_TAGLINE;
const canonicalUrl = new URL(Astro.url.pathname, SITE_URL).toString();

const articleJsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: post.data.title,
  description,
  datePublished: post.data.pubDate.toISOString(),
  dateModified: (post.data.updatedDate ?? post.data.pubDate).toISOString(),
  author: {
    "@type": "Organization",
    name: authorName,
  },
  publisher: {
    "@type": "Organization",
    name: BRAND_NAME,
  },
  mainEntityOfPage: canonicalUrl,
};

const breadcrumbSchema = generateBreadcrumbSchema([
  { name: "Strona główna", url: "/" },
  { name: "Blog", url: "/blog" },
  { name: post.data.title },
]);
---

<MainLayout
  title={title}
  description={description}
  ogType="article"
  canonical={canonicalUrl}
  structuredData={[articleJsonLd, breadcrumbSchema]}
>
  <article class="section">
    <div class="container-site">
      <div class="flex flex-wrap items-center gap-2 text-xs font-bold uppercase tracking-widest text-slate-500">
        <span>Blog</span>
        <span aria-hidden="true">·</span>
        <time datetime={post.data.pubDate.toISOString()}>{publishedDate}</time>
        {
          updatedDate && (
            <>
              <span aria-hidden="true">·</span>
              <span class="text-slate-400">Aktualizacja:</span>
              <time datetime={post.data.updatedDate?.toISOString()}>{updatedDate}</time>
            </>
          )
        }
      </div>

      <div class={`mt-8 grid gap-10 ${hasToc ? "lg:grid-cols-[minmax(0,1fr)_18rem]" : ""}`}>
        <div>
          <div class="prose prose-slate max-w-none">
            <Content />
          </div>

          <section class="mt-10 rounded-2xl border border-slate-200 bg-slate-50 p-6">
            <p class="text-xs font-bold uppercase tracking-widest text-slate-500">Polecane kursy</p>
            <h2 class="mt-3 text-2xl text-slate-900">Sprawdź ofertę pasującą do tematu</h2>
            <p class="mt-3 text-sm text-slate-600">
              Wybierz kurs i format pracy — dobierzemy poziom i plan zajęć do Twojego celu.
            </p>
            <div class="mt-6 grid gap-4 sm:grid-cols-2">
              {[primaryOffer, secondaryOffer].map((offer) => (
                <a class="card-interactive group no-underline" href={offer.href}>
                  <h3 class="text-lg font-extrabold text-slate-900">{offer.title}</h3>
                  <p class="mt-2 text-sm text-slate-600">{offer.description}</p>
                  <span class="mt-4 inline-flex items-center gap-2 text-sm font-bold text-primary transition-all group-hover:gap-3">
                    Zobacz szczegóły
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                    </svg>
                  </span>
                </a>
              ))}
            </div>
            <div class="mt-6 flex flex-wrap gap-3">
              <a class="btn btn-primary" href={CTA_PRIMARY_HREF}>{CTA_PRIMARY_LABEL}</a>
            </div>
          </section>

          <section class="mt-10 rounded-2xl border border-slate-200 p-6">
            <p class="text-xs font-bold uppercase tracking-widest text-slate-500">Autor</p>
            <p class="mt-3 text-xl font-extrabold text-slate-900">{authorName}</p>
            <p class="mt-2 text-sm text-slate-600">{authorRole}</p>
          </section>

          {
            relatedPosts.length > 0 && (
              <section class="mt-10">
                <h2 class="text-2xl text-slate-900">Powiązane wpisy</h2>
                <div class="mt-6 grid gap-4 sm:grid-cols-2">
                  {relatedPosts.map((item) => (
                    <a class="card-interactive group no-underline" href={`/blog/${item.slug}`}>
                      <div class="text-xs font-bold uppercase tracking-widest text-slate-500">
                        {formatDate(item.data.pubDate)}
                      </div>
                      <h3 class="mt-3 text-lg font-extrabold text-slate-900">{item.data.title}</h3>
                      <p class="mt-2 text-sm text-slate-600">{item.data.description}</p>
                    </a>
                  ))}
                </div>
              </section>
            )
          }

          <div class="mt-10 flex flex-wrap gap-3">
            <a class="btn btn-secondary" href="/blog">Wróć do bloga</a>
            <a class="btn btn-ghost" href="/cennik">Zobacz cennik</a>
          </div>
        </div>

        {
          hasToc && (
            <aside class="lg:sticky lg:top-24 lg:self-start">
              <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-soft">
                <p class="text-xs font-bold uppercase tracking-widest text-slate-500">Spis treści</p>
                <nav class="mt-4 text-sm text-slate-600" aria-label="Spis treści">
                  <ol class="space-y-2">
                    {tocHeadings.map((heading) => (
                      <li class={heading.depth === 3 ? "pl-4" : ""}>
                        <a
                          class="block no-underline transition hover:text-primary"
                          href={`#${heading.slug}`}
                        >
                          {heading.text}
                        </a>
                      </li>
                    ))}
                  </ol>
                </nav>
              </div>
            </aside>
          )
        }
      </div>
    </div>
  </article>
</MainLayout>
