---
import MainLayout from "../layouts/MainLayout.astro";
import {
  BRAND_NAME,
  BUSINESS,
  CONTACT_EMAIL,
  CONTACT_PHONE,
  FULL_ADDRESS,
  isTodo,
  generateBreadcrumbSchema,
} from "../config/site";

const title = `Kontakt – szkoła angielskiego Legionowo | ${BRAND_NAME}`;
const description =
  "Skontaktuj się i umów konsultację oraz diagnozę poziomu w szkole Lingua Legionowo. Oferujemy kursy stacjonarne i online. Odpowiadamy szybko.";

const hasEmail = !isTodo(CONTACT_EMAIL);
const hasPhone = !isTodo(CONTACT_PHONE);
const formAction = hasEmail ? "/api/kontakt" : "#";
const emailFallback = "Skontaktuj się przez formularz.";
const phoneFallback = "Skontaktuj się przez formularz.";
const addressLine = FULL_ADDRESS || BUSINESS.city;
const hasAddress = Boolean(addressLine);
const hasHours = Boolean(BUSINESS.openingHours);
const mapHref = hasAddress
  ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addressLine)}`
  : "";

const breadcrumbSchema = generateBreadcrumbSchema([
  { name: "Strona główna", url: "/" },
  { name: "Kontakt" },
]);
---

<MainLayout
  title={title}
  description={description}
  canonical="/kontakt"
  structuredData={[breadcrumbSchema]}
>
  <section class="hero-bg">
    <div class="container-site py-16 sm:py-20">
      <div class="grid gap-10 lg:grid-cols-2 lg:items-start">
        <div>
          <span class="kicker">Kontakt</span>
          <h1 class="mt-6">Skontaktuj się z nami — Lingua Legionowo</h1>
          <p class="mt-6 max-w-2xl text-lg">
            Napisz kilka słów o swoim poziomie i celu. Zaproponujemy plan nauki i terminy —
            stacjonarnie w Legionowie lub online.
          </p>
          <p class="mt-3 text-sm text-slate-600">
            Konsultacja obejmuje rozmowę o celu, krótką diagnozę poziomu i propozycję planu.
          </p>

          <div class="mt-10 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            <div class="card p-6">
              <div class="text-xs font-bold uppercase tracking-widest text-slate-500">E-mail</div>
              <div class="mt-3 text-base font-extrabold text-primary">
                {
                  hasEmail ? (
                    <a class="no-underline" href={`mailto:${CONTACT_EMAIL}`}>
                      {CONTACT_EMAIL}
                    </a>
                  ) : (
                    <span>{emailFallback}</span>
                  )
                }
              </div>
              <p class="mt-2 text-sm">Odpowiadamy najszybciej mailowo.</p>
            </div>

            <div class="card p-6">
              <div class="text-xs font-bold uppercase tracking-widest text-slate-500">Telefon</div>
              <div class="mt-3 text-base font-extrabold text-primary">
                {
                  hasPhone ? (
                    <a class="no-underline" href={`tel:${CONTACT_PHONE}`}>
                      {CONTACT_PHONE}
                    </a>
                  ) : (
                    <span>{phoneFallback}</span>
                  )
                }
              </div>
              <p class="mt-2 text-sm">Jeśli nie odbierzemy, oddzwonimy.</p>
            </div>
            {
              (hasAddress || hasHours) && (
                <div class="card p-6">
                  <div class="text-xs font-bold uppercase tracking-widest text-slate-500">
                    Lokalizacja
                  </div>
                  {hasAddress && (
                    <div class="mt-3 text-base font-extrabold text-slate-900">{addressLine}</div>
                  )}
                  {hasAddress && (
                    <a
                      class="mt-2 inline-flex text-sm font-bold text-primary no-underline hover:underline"
                      href={mapHref}
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      Zobacz na mapie
                    </a>
                  )}
                  {hasHours && (
                    <p class="mt-2 text-sm text-slate-600">
                      Godziny otwarcia: {BUSINESS.openingHours}
                    </p>
                  )}
                </div>
              )
            }
          </div>

          <p class="mt-6 text-sm text-slate-500">
            Szkoła Lingua znajduje się w centrum Legionowa. Oferujemy także lekcje online dla osób
            spoza Legionowa.
          </p>
          <p class="mt-2 text-sm text-slate-500">
            Zobacz też
            <a
              class="font-bold text-primary no-underline hover:underline"
              href="/angielski-stacjonarnie">zajęcia stacjonarne</a
            >,
            <a class="font-bold text-primary no-underline hover:underline" href="/angielski-online"
              >lekcje online</a
            >
            i
            <a class="font-bold text-primary no-underline hover:underline" href="/cennik">cennik</a
            >.
          </p>
        </div>

        <div class="card p-6" id="formularz">
          <h2 class="text-lg font-extrabold text-slate-900">Formularz kontaktowy</h2>
          <p class="mt-2 text-sm text-slate-600">Pola oznaczone * są wymagane.</p>

          <form
            method="post"
            action={formAction}
            class="mt-6 space-y-4"
            aria-label="Formularz kontaktowy"
            data-contact-form
          >
            <!-- Honeypot field for spam prevention - hidden from users -->
            <div class="absolute -left-[9999px] h-px w-px overflow-hidden" aria-hidden="true">
              <label for="company">Firma</label>
              <input id="company" name="company" type="text" tabindex="-1" autocomplete="off" />
            </div>

            <div
              id="form-alert"
              class="hidden rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-700"
              role="alert"
            >
            </div>

            <div>
              <label for="name" class="text-sm font-bold text-slate-900">Imię i nazwisko *</label>
              <input
                id="name"
                name="name"
                autocomplete="name"
                required
                minlength="2"
                aria-describedby="name-error"
                class="mt-1 w-full rounded-xl border-slate-300 bg-white focus:border-primary focus:ring-primary"
              />
              <p id="name-error" class="mt-1 text-xs text-rose-600" aria-live="polite"></p>
            </div>

            <div>
              <label for="email" class="text-sm font-bold text-slate-900">E-mail *</label>
              <input
                id="email"
                name="email"
                type="email"
                autocomplete="email"
                required
                aria-describedby="email-error"
                class="mt-1 w-full rounded-xl border-slate-300 bg-white focus:border-primary focus:ring-primary"
              />
              <p id="email-error" class="mt-1 text-xs text-rose-600" aria-live="polite"></p>
            </div>

            <div>
              <label for="phone" class="text-sm font-bold text-slate-900"
                >Telefon (opcjonalnie)</label
              >
              <input
                id="phone"
                name="phone"
                type="tel"
                autocomplete="tel"
                aria-describedby="phone-error"
                class="mt-1 w-full rounded-xl border-slate-300 bg-white focus:border-primary focus:ring-primary"
              />
              <p id="phone-error" class="mt-1 text-xs text-rose-600" aria-live="polite"></p>
            </div>

            <div>
              <label for="message" class="text-sm font-bold text-slate-900">Wiadomość *</label>
              <textarea
                id="message"
                name="message"
                required
                minlength="20"
                aria-describedby="message-error"
                class="mt-1 min-h-[120px] w-full rounded-xl border-slate-300 bg-white focus:border-primary focus:ring-primary"
                placeholder="Np. poziom, cel, preferowane dni/godziny…"></textarea>
              <p id="message-error" class="mt-1 text-xs text-rose-600" aria-live="polite"></p>
            </div>

            <div class="flex items-start gap-3 text-sm text-slate-600">
              <input
                id="consent"
                name="consent"
                type="checkbox"
                required
                aria-describedby="consent-error"
                class="mt-1 h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary"
              />
              <label for="consent">
                Wyrażam zgodę na kontakt w sprawie kursu zgodnie z
                <a class="font-bold text-primary no-underline hover:underline" href="/privacy"
                  >polityką prywatności</a
                >.
              </label>
            </div>
            <p id="consent-error" class="text-xs text-rose-600" aria-live="polite"></p>

            <button class="btn btn-primary w-full" type="submit" id="submit-btn">
              <span id="submit-text">Wyślij wiadomość</span>
              <span id="submit-loading" class="hidden items-center gap-2">
                <svg
                  class="h-4 w-4 animate-spin"
                  viewBox="0 0 24 24"
                  fill="none"
                  aria-hidden="true"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
                Wysyłanie...
              </span>
            </button>
          </form>

          <div
            id="contact-success"
            class="mt-6 hidden rounded-xl border border-emerald-200 bg-emerald-50 p-4 text-sm text-emerald-800"
            role="status"
            tabindex="-1"
          >
            <strong>Dziękujemy!</strong> Twoja wiadomość została wysłana. Odezwiemy się w ciągu 1–2 dni
            roboczych.
          </div>
        </div>
      </div>
    </div>
  </section>

  <script is:inline>
    const form = document.querySelector("[data-contact-form]");
    const alertEl = document.getElementById("form-alert");
    const successEl = document.getElementById("contact-success");
    const honeypotEl = document.getElementById("company");
    const submitBtn = document.getElementById("submit-btn");
    const submitText = document.getElementById("submit-text");
    const submitLoading = document.getElementById("submit-loading");

    const fields = [
      { id: "name", min: 2, message: "Podaj imię i nazwisko (min. 2 znaki)." },
      { id: "email", type: "email", message: "Podaj poprawny adres e-mail." },
      { id: "message", min: 20, message: "Wiadomość powinna mieć co najmniej 20 znaków." },
      { id: "consent", type: "checkbox", message: "Wymagana jest zgoda na kontakt." },
    ];

    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
    const throttleMs = 60 * 1000;
    const throttleKey = "lingua-contact-throttle";

    const getErrorEl = (id) => document.getElementById(`${id}-error`);

    const setError = (field, message) => {
      const errorEl = getErrorEl(field.id);
      if (errorEl) errorEl.textContent = message;
      field.setAttribute("aria-invalid", "true");
    };

    const clearError = (field) => {
      const errorEl = getErrorEl(field.id);
      if (errorEl) errorEl.textContent = "";
      field.removeAttribute("aria-invalid");
    };

    const validate = () => {
      let firstInvalid = null;
      fields.forEach((rule) => {
        const field = document.getElementById(rule.id);
        if (!field) return;
        clearError(field);

        const value = field.type === "checkbox" ? field.checked : field.value.trim();
        let valid = true;

        if (rule.type === "checkbox") {
          valid = Boolean(value);
        } else if (rule.type === "email") {
          valid = emailPattern.test(value);
        } else if (rule.min) {
          valid = value.length >= rule.min;
        }

        if (!valid) {
          setError(field, rule.message);
          if (!firstInvalid) firstInvalid = field;
        }
      });

      if (firstInvalid) {
        firstInvalid.focus();
      }

      return !firstInvalid;
    };

    const showAlert = (message) => {
      if (!alertEl) return;
      alertEl.textContent = message;
      alertEl.classList.remove("hidden");
      alertEl.scrollIntoView({ behavior: "smooth", block: "center" });
    };

    const clearAlert = () => {
      if (!alertEl) return;
      alertEl.textContent = "";
      alertEl.classList.add("hidden");
    };

    const setLoading = (loading) => {
      if (submitBtn) {
        submitBtn.disabled = loading;
        submitBtn.setAttribute("aria-busy", String(loading));
      }
      if (submitText) submitText.classList.toggle("hidden", loading);
      if (submitLoading) {
        submitLoading.classList.toggle("hidden", !loading);
        submitLoading.classList.toggle("inline-flex", loading);
      }
    };

    const showSuccess = () => {
      if (form) form.classList.add("hidden");
      if (successEl) {
        successEl.classList.remove("hidden");
        successEl.focus();
      }
    };

    form?.addEventListener("input", (event) => {
      const target = event.target;
      if (!target?.id) return;
      clearAlert();
      clearError(target);
    });

    form?.addEventListener("submit", async (event) => {
      event.preventDefault();
      clearAlert();

      if (honeypotEl?.value?.trim()) {
        showAlert("Wykryliśmy podejrzaną aktywność. Spróbuj ponownie za chwilę.");
        return;
      }

      const lastSubmit = Number(localStorage.getItem(throttleKey) || 0);
      if (Date.now() - lastSubmit < throttleMs) {
        showAlert("Prosimy odczekać minutę przed kolejną próbą wysłania formularza.");
        return;
      }

      if (!validate()) {
        return;
      }

      setLoading(true);

      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: "POST",
          body: formData,
        });

        // Handle mailto redirect (fallback when Resend not configured)
        if (response.redirected && response.url.startsWith("mailto:")) {
          localStorage.setItem(throttleKey, String(Date.now()));
          window.location.href = response.url;
          showSuccess();
          return;
        }

        // Handle 303 redirect to mailto (for browsers that don't follow automatically)
        if (response.status === 303) {
          const mailto = response.headers.get("Location");
          if (mailto?.startsWith("mailto:")) {
            localStorage.setItem(throttleKey, String(Date.now()));
            window.location.href = mailto;
            showSuccess();
            return;
          }
        }

        const data = await response.json();

        if (!response.ok || !data.success) {
          showAlert(data.error || "Wystąpił błąd. Spróbuj ponownie.");
          return;
        }

        localStorage.setItem(throttleKey, String(Date.now()));
        showSuccess();
      } catch (error) {
        console.error("Form submission error:", error);
        showAlert("Wystąpił błąd połączenia. Sprawdź internet i spróbuj ponownie.");
      } finally {
        setLoading(false);
      }
    });
  </script>
</MainLayout>
