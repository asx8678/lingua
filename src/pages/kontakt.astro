---
import MainLayout from "../layouts/MainLayout.astro";
import {
  BRAND_NAME,
  BUSINESS,
  CONTACT_EMAIL,
  CONTACT_PHONE,
  FULL_ADDRESS,
  generateBreadcrumbSchema,
} from "../config/site";
import { taughtLanguages } from "../data/subjects";

const title = `Kontakt – szkoła językowa i matematyka w Legionowie | ${BRAND_NAME}`;
const description =
  "Napisz do nas — pomożemy dobrać plan nauki w szkole Lingua Legionowo. Zajęcia stacjonarne w Legionowie i online. Odpowiadamy szybko.";

const hasEmail = !!CONTACT_EMAIL;
const hasPhone = !!CONTACT_PHONE;
const formAction = hasEmail ? "/api/kontakt" : "#";
const emailFallback = "Napisz przez formularz.";
const phoneFallback = "Napisz przez formularz.";
const addressLine = FULL_ADDRESS || BUSINESS.city;
const hasAddress = Boolean(addressLine);
const hasHours = Boolean(BUSINESS.openingHours);
const mapQuery = `Lingua Szkoła języka Angielskiego, ${addressLine}`;
const mapHref = hasAddress
  ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapQuery)}`
  : "";
const mapEmbedSrc = hasAddress
  ? `https://www.google.com/maps?q=${encodeURIComponent(mapQuery)}&output=embed`
  : "";
const otherLanguages = taughtLanguages.filter((language) => language !== "Angielski");

const breadcrumbSchema = generateBreadcrumbSchema([
  { name: "Strona główna", url: "/" },
  { name: "Kontakt" },
]);

// Tailwind class constants
const btnBase = "inline-flex items-center justify-center gap-2 rounded-full px-6 py-2.5 text-sm font-medium transition-colors duration-150";
const btnPrimary = `${btnBase} bg-primary text-white hover:bg-primary-600`;
const btnSecondary = `${btnBase} border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 hover:text-slate-800`;
const card = "rounded-xl border border-slate-200/80 bg-white transition-all duration-200 hover:shadow-soft hover:border-slate-200";
const kicker = "text-[11px] font-semibold uppercase tracking-wider text-primary";
---

<MainLayout
  title={title}
  description={description}
  canonical="/kontakt"
  structuredData={[breadcrumbSchema]}
>
  <section class="bg-hero-gradient">
    <div class="mx-auto w-full max-w-7xl px-6 py-16 sm:py-24">
      <div class="grid gap-10 lg:grid-cols-2 lg:items-start">
        <div>
          <span class={kicker}>Kontakt</span>
          <h1 class="mt-5">Skontaktuj się z nami</h1>
          <p class="mt-4 max-w-2xl text-slate-600">
            Napisz o swoim poziomie i celu — zaproponujemy plan nauki i terminy. Zajęcia prowadzimy stacjonarnie w Legionowie oraz online.
          </p>

          <div class="mt-10 grid gap-4 sm:grid-cols-3">
            <div class={`${card} p-5 text-center sm:text-left`}>
              <div class="text-xs font-bold uppercase tracking-widest text-slate-500">E-mail</div>
              <div class="mt-3 text-sm font-bold text-primary break-all">
                {
                  hasEmail ? (
                    <a class="no-underline hover:underline" href={`mailto:${CONTACT_EMAIL}`}>
                      {CONTACT_EMAIL}
                    </a>
                  ) : (
                    <span>{emailFallback}</span>
                  )
                }
              </div>
              <p class="mt-2 text-sm text-slate-600">Odpowiadamy szybko.</p>
            </div>

            <div class={`${card} p-5 text-center sm:text-left`}>
              <div class="text-xs font-bold uppercase tracking-widest text-slate-500">Telefon</div>
              <div class="mt-3 text-sm font-bold text-primary whitespace-nowrap">
                {
                  hasPhone ? (
                    <a class="no-underline hover:underline" href={`tel:${CONTACT_PHONE}`}>
                      {CONTACT_PHONE}
                    </a>
                  ) : (
                    <span>{phoneFallback}</span>
                  )
                }
              </div>
              <p class="mt-2 text-sm text-slate-600">Oddzwonimy, jeśli nie odbierzemy.</p>
            </div>
            {
              (hasAddress || hasHours) && (
                <div class={`${card} p-5 text-center sm:text-left`}>
                  <div class="text-xs font-bold uppercase tracking-widest text-slate-500">
                    Lokalizacja
                  </div>
                  {hasAddress && (
                    <div class="mt-3 text-sm font-bold text-slate-900">{addressLine}</div>
                  )}
                  {hasAddress && (
                    <a
                      class="mt-2 inline-flex text-sm font-bold text-primary no-underline hover:underline"
                      href={mapHref}
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      Zobacz na mapie →
                    </a>
                  )}
                  {hasHours && (
                    <p class="mt-2 text-sm text-slate-600">
                      {BUSINESS.openingHours}
                    </p>
                  )}
                </div>
              )
            }
          </div>

          <p class="mt-6 text-sm text-slate-500">
            Szkoła Lingua znajduje się w centrum Legionowa. Oferujemy także lekcje online dla osób
            spoza Legionowa.
          </p>
          <p class="mt-2 text-sm text-slate-500">
            Zobacz też
            <a
              class="font-bold text-primary no-underline hover:underline"
              href="/angielski-stacjonarnie">zajęcia stacjonarne</a
            >,
            <a class="font-bold text-primary no-underline hover:underline" href="/angielski-online"
              >lekcje online</a
            >
            i
            <a class="font-bold text-primary no-underline hover:underline" href="/cennik">cennik</a
            >.
          </p>
        </div>

        <div class={`${card} p-6 sm:p-8`} id="formularz">
          <h2 class="text-lg font-bold text-slate-900">Formularz kontaktowy</h2>
          <p class="mt-2 text-sm text-slate-500">Pola oznaczone * są wymagane.</p>

          <div class="mt-6 rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <p class="text-sm font-bold text-slate-900">Szybkie dopasowanie (opcjonalne)</p>
                <p class="mt-1 text-sm text-slate-600">
                  3 krótkie pytania — wybierz, jeśli chcesz szybciej dobrać język i plan nauki.
                </p>
              </div>
              <div class="flex flex-wrap gap-2" role="group" aria-label="Szybkie dopasowanie">
                <button class={`${btnSecondary} px-4 py-2 text-xs`} type="button" id="quick-fit-on">
                  Szybkie dopasowanie
                </button>
                <button class={`${btnPrimary} px-4 py-2 text-xs`} type="button" id="quick-fit-off">
                  Tylko formularz
                </button>
              </div>
            </div>
          </div>

          <form
            method="post"
            action={formAction}
            class="mt-6 space-y-4"
            aria-label="Formularz kontaktowy"
            data-contact-form
            data-track-form="contact"
            novalidate
          >
            <!-- Honeypot field for spam prevention - hidden from users -->
            <div class="absolute -left-[9999px] h-px w-px overflow-hidden" aria-hidden="true">
              <label for="website">Strona</label>
              <input id="website" name="website" type="text" tabindex="-1" autocomplete="off" />
            </div>

            <div
              id="form-alert"
              class="hidden rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-700"
              role="alert"
            >
            </div>

            <input id="summary" name="summary" type="hidden" />

            <div class="rounded-2xl border border-slate-200 bg-slate-50 p-5" data-step="1">
              <p class="text-xs font-bold uppercase tracking-widest text-slate-500">Krok 1</p>
              <h3 class="mt-2 text-base font-bold text-slate-900">Szybkie dopasowanie</h3>
              <p class="mt-2 text-sm text-slate-600">
                Zaznacz kilka informacji — przygotujemy odpowiednią propozycję.
              </p>

              <fieldset class="mt-4">
                <legend class="text-sm font-bold text-slate-900">Czego dotyczy? *</legend>
                <div class="mt-2 flex flex-wrap gap-2">
                  <label class="cursor-pointer">
                    <input class="sr-only peer" type="radio" name="topic" value="Angielski" required />
                    <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600 transition peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white">
                      Angielski
                    </span>
                  </label>
                  <label class="cursor-pointer">
                    <input class="sr-only peer" type="radio" name="topic" value="Inny język" required />
                    <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600 transition peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white">
                      Inny język
                    </span>
                  </label>
                  <label class="cursor-pointer">
                    <input class="sr-only peer" type="radio" name="topic" value="Matematyka" required />
                    <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600 transition peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white">
                      Matematyka
                    </span>
                  </label>
                </div>
                <p id="topic-error" class="mt-2 text-xs text-rose-600" aria-live="polite"></p>
              </fieldset>

              <fieldset class="mt-4 hidden" data-other-language>
                <legend class="text-sm font-bold text-slate-900">Wybierz język *</legend>
                {
                  otherLanguages.length > 0 ? (
                    <div class="mt-2 flex flex-wrap gap-2">
                      {otherLanguages.map((language) => (
                        <label class="cursor-pointer">
                          <input class="sr-only peer" type="radio" name="language" value={language} />
                          <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600 transition peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white">
                            {language}
                          </span>
                        </label>
                      ))}
                    </div>
                  ) : (
                    <p class="mt-2 text-xs text-slate-500">
                      Aktualnie nie mamy innych języków w ofercie.
                    </p>
                  )
                }
                <p id="language-error" class="mt-2 text-xs text-rose-600" aria-live="polite"></p>
              </fieldset>

              <fieldset class="mt-4">
                <legend class="text-sm font-bold text-slate-900">Dla kogo są zajęcia? *</legend>
                <div class="mt-2 flex flex-wrap gap-2">
                  <label class="cursor-pointer">
                    <input class="sr-only peer" type="radio" name="audience" value="Dziecko" required />
                    <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600 transition peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white">
                      Dziecko
                    </span>
                  </label>
                  <label class="cursor-pointer">
                    <input class="sr-only peer" type="radio" name="audience" value="Nastolatek" required />
                    <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600 transition peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white">
                      Nastolatek
                    </span>
                  </label>
                  <label class="cursor-pointer">
                    <input class="sr-only peer" type="radio" name="audience" value="Dorosły" required />
                    <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600 transition peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white">
                      Dorosły
                    </span>
                  </label>
                  <label class="cursor-pointer">
                    <input class="sr-only peer" type="radio" name="audience" value="Firma" required />
                    <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600 transition peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white">
                      Firma
                    </span>
                  </label>
                </div>
                <p id="audience-error" class="mt-2 text-xs text-rose-600" aria-live="polite"></p>
              </fieldset>

              <fieldset class="mt-4">
                <legend class="text-sm font-bold text-slate-900">Tryb zajęć *</legend>
                <div class="mt-2 flex flex-wrap gap-2">
                  <label class="cursor-pointer">
                    <input class="sr-only peer" type="radio" name="mode" value="Stacjonarnie" required />
                    <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600 transition peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white">
                      Stacjonarnie
                    </span>
                  </label>
                  <label class="cursor-pointer">
                    <input class="sr-only peer" type="radio" name="mode" value="Online" required />
                    <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600 transition peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white">
                      Online
                    </span>
                  </label>
                </div>
                <p id="mode-error" class="mt-2 text-xs text-rose-600" aria-live="polite"></p>
              </fieldset>

              <div class="mt-6">
                <button
                  class={`${btnSecondary} w-full sm:w-auto`}
                  type="button"
                  id="form-step-next"
                  disabled
                >
                  Przejdź do danych kontaktowych
                </button>
              </div>
            </div>

            <div class="space-y-4" data-step="2">
              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm" data-summary>
                <div class="text-xs font-bold uppercase tracking-widest text-slate-500">
                  Podsumowanie
                </div>
                <p id="form-summary" class="mt-2 text-slate-600">
                  Uzupełnij wybory w szybkim dopasowaniu, aby zobaczyć podsumowanie.
                </p>
              </div>

              <div>
                <label for="name" class="text-sm font-bold text-slate-900">Imię *</label>
                <input
                  id="name"
                  name="name"
                  autocomplete="given-name"
                  required
                  minlength="2"
                  aria-describedby="name-error"
                  class="mt-1 w-full rounded-xl border-slate-300 bg-white focus:border-primary focus:ring-primary"
                />
                <p id="name-error" class="mt-1 text-xs text-rose-600" aria-live="polite"></p>
              </div>

              <div>
                <label for="email" class="text-sm font-bold text-slate-900">E-mail *</label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  autocomplete="email"
                  required
                  aria-describedby="email-error"
                  class="mt-1 w-full rounded-xl border-slate-300 bg-white focus:border-primary focus:ring-primary"
                />
                <p id="email-error" class="mt-1 text-xs text-rose-600" aria-live="polite"></p>
              </div>

              <div>
                <label for="phone" class="text-sm font-bold text-slate-900"
                  >Telefon (opcjonalnie)</label
                >
                <input
                  id="phone"
                  name="phone"
                  type="tel"
                  autocomplete="tel"
                  aria-describedby="phone-error"
                  class="mt-1 w-full rounded-xl border-slate-300 bg-white focus:border-primary focus:ring-primary"
                />
                <p id="phone-error" class="mt-1 text-xs text-rose-600" aria-live="polite"></p>
              </div>

              <div>
                <label for="company" class="text-sm font-bold text-slate-900"
                  >Firma (opcjonalnie)</label
                >
                <input
                  id="company"
                  name="company"
                  autocomplete="organization"
                  class="mt-1 w-full rounded-xl border-slate-300 bg-white focus:border-primary focus:ring-primary"
                />
              </div>

              <div>
                <label for="availability" class="text-sm font-bold text-slate-900">
                  Preferowane godziny (opcjonalnie)
                </label>
                <input
                  id="availability"
                  name="availability"
                  autocomplete="off"
                  class="mt-1 w-full rounded-xl border-slate-300 bg-white focus:border-primary focus:ring-primary"
                  placeholder="Np. wt/czw po 17:00, soboty rano"
                />
              </div>

              <div>
                <label for="message" class="text-sm font-bold text-slate-900">Wiadomość *</label>
                <textarea
                  id="message"
                  name="message"
                  required
                  minlength="5"
                  aria-describedby="message-error"
                  class="mt-1 min-h-[140px] w-full rounded-xl border-slate-300 bg-white focus:border-primary focus:ring-primary"
                  placeholder="Dopisz poziom, cel, preferowane dni/godziny…"></textarea>
                <p id="message-error" class="mt-1 text-xs text-rose-600" aria-live="polite"></p>
              </div>

              <div class="flex items-start gap-3 text-sm text-slate-600">
                <input
                  id="consent"
                  name="consent"
                  type="checkbox"
                  required
                  aria-describedby="consent-error"
                  class="mt-1 h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary"
                />
                <label for="consent">
                  Wyrażam zgodę na kontakt w sprawie kursu zgodnie z
                  <a class="font-bold text-primary no-underline hover:underline" href="/privacy"
                    >polityką prywatności</a
                  >.
                </label>
              </div>
              <p id="consent-error" class="text-xs text-rose-600" aria-live="polite"></p>

              <button class={`${btnPrimary} w-full`} type="submit" id="submit-btn">
                <span id="submit-text">Wyślij wiadomość</span>
                <span id="submit-loading" class="hidden items-center gap-2">
                  <svg
                    class="h-4 w-4 animate-spin"
                    viewBox="0 0 24 24"
                    fill="none"
                    aria-hidden="true"
                  >
                    <circle
                      class="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      stroke-width="4"></circle>
                    <path
                      class="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    ></path>
                  </svg>
                  Wysyłanie...
                </span>
              </button>
            </div>
          </form>

        </div>
      </div>
    </div>
  </section>

  {
    hasAddress && (
      <section class="py-16 lg:py-24 bg-slate-50/60">
        <div class="mx-auto w-full max-w-7xl px-6">
          <div class="grid gap-8 lg:grid-cols-2 lg:items-center">
            <div class={`${card} overflow-hidden p-0`}>
              <iframe
                title={`Mapa dojazdu — ${BRAND_NAME}`}
                src={mapEmbedSrc}
                loading="lazy"
                class="h-80 w-full border-0"
                referrerpolicy="no-referrer-when-downgrade"
              ></iframe>
            </div>

            <div>
              <span class={kicker}>Lokalizacja</span>
              <h2 class="mt-4">Znajdziesz nas w centrum Legionowa</h2>
              <p class="mt-4 text-sm text-slate-600">
                Spotkajmy się w naszej placówce lub umów konsultację online. Wszystkie dane kontaktowe
                masz pod ręką poniżej.
              </p>
              <ul class="mt-6 space-y-2 text-sm text-slate-600">
                {hasAddress && (
                  <li>
                    <span class="font-bold text-slate-900">Adres:</span> {addressLine}
                  </li>
                )}
                {hasHours && (
                  <li>
                    <span class="font-bold text-slate-900">Godziny:</span> {BUSINESS.openingHours}
                  </li>
                )}
                {hasPhone && (
                  <li>
                    <span class="font-bold text-slate-900">Telefon:</span>{" "}
                    <a class="font-bold text-primary no-underline hover:underline" href={`tel:${CONTACT_PHONE}`}>
                      {CONTACT_PHONE}
                    </a>
                  </li>
                )}
                {hasEmail && (
                  <li>
                    <span class="font-bold text-slate-900">E-mail:</span>{" "}
                    <a class="font-bold text-primary no-underline hover:underline" href={`mailto:${CONTACT_EMAIL}`}>
                      {CONTACT_EMAIL}
                    </a>
                  </li>
                )}
              </ul>
              {mapHref && (
                <div class="mt-6">
                  <a class={btnSecondary} href={mapHref} target="_blank" rel="noopener noreferrer">
                    Otwórz w Google Maps
                  </a>
                </div>
              )}
            </div>
          </div>
        </div>
      </section>
    )
  }

  <script is:inline>
    const form = document.querySelector("[data-contact-form]");
    const alertEl = document.getElementById("form-alert");
    const honeypotEl = document.getElementById("website");
    const submitBtn = document.getElementById("submit-btn");
    const submitText = document.getElementById("submit-text");
    const submitLoading = document.getElementById("submit-loading");
    const step1El = document.querySelector('[data-step="1"]');
    const step2El = document.querySelector('[data-step="2"]');
    const stepNextBtn = document.getElementById("form-step-next");
    const quickFitOnBtn = document.getElementById("quick-fit-on");
    const quickFitOffBtn = document.getElementById("quick-fit-off");
    const summaryCard = document.querySelector("[data-summary]");
    const summaryEl = document.getElementById("form-summary");
    const summaryInput = document.getElementById("summary");
    const otherLanguageFieldset = document.querySelector("[data-other-language]");
    const languageInputs = form?.querySelectorAll('input[name="language"]') ?? [];
    const messageField = document.getElementById("message");
    const availabilityField = document.getElementById("availability");
    let messageTouched = false;
    let quickFitEnabled = false;

    const fields = [
      { id: "name", min: 2, message: "Podaj imię (min. 2 znaki)." },
      { id: "email", type: "email", message: "Podaj poprawny adres e-mail." },
      { id: "message", min: 5, message: "Wiadomość powinna mieć co najmniej 5 znaków." },
      { id: "consent", type: "checkbox", message: "Wymagana jest zgoda na kontakt." },
    ];
    const groupFields = [
      { name: "topic", message: "Wybierz temat zajęć." },
      { name: "audience", message: "Wybierz, dla kogo są zajęcia." },
      { name: "mode", message: "Wybierz preferowany tryb zajęć." },
    ];
    const groupFieldNames = new Set([...groupFields.map((group) => group.name), "language"]);

    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
    const throttleMs = 60 * 1000;
    const throttleKey = "lingua-contact-throttle";

    const getErrorEl = (id) => document.getElementById(`${id}-error`);
    const getGroupErrorEl = (name) => document.getElementById(`${name}-error`);
    const getSelectedValue = (name) =>
      form?.querySelector(`input[name="${name}"]:checked`)?.value ?? "";

    const setError = (field, message) => {
      const errorEl = getErrorEl(field.id);
      if (errorEl) errorEl.textContent = message;
      field.setAttribute("aria-invalid", "true");
    };

    const clearError = (field) => {
      const errorEl = getErrorEl(field.id);
      if (errorEl) errorEl.textContent = "";
      field.removeAttribute("aria-invalid");
    };

    const setGroupError = (name, message) => {
      const errorEl = getGroupErrorEl(name);
      if (errorEl) errorEl.textContent = message;
      const firstField = form?.querySelector(`input[name="${name}"]`);
      if (firstField) firstField.setAttribute("aria-invalid", "true");
    };

    const clearGroupError = (name) => {
      const errorEl = getGroupErrorEl(name);
      if (errorEl) errorEl.textContent = "";
      form?.querySelectorAll(`input[name="${name}"]`).forEach((field) => {
        field.removeAttribute("aria-invalid");
      });
    };

    const applyFieldErrors = (fieldErrors) => {
      if (!fieldErrors) return;
      let firstInvalid = null;

      Object.entries(fieldErrors).forEach(([id, message]) => {
        const field = document.getElementById(id);
        if (!field) return;
        setError(field, message);
        if (!firstInvalid) firstInvalid = field;
      });

      if (firstInvalid) {
        firstInvalid.focus();
      }
    };

    const updateOtherLanguageVisibility = () => {
      const isOtherLanguage = quickFitEnabled && getSelectedValue("topic") === "Inny język";
      if (otherLanguageFieldset) {
        otherLanguageFieldset.classList.toggle("hidden", !isOtherLanguage);
        otherLanguageFieldset.setAttribute("aria-hidden", String(!isOtherLanguage));
      }
      languageInputs.forEach((input) => {
        input.disabled = !isOtherLanguage;
        if (!isOtherLanguage) input.checked = false;
      });
      if (!isOtherLanguage) {
        clearGroupError("language");
      }
    };

    const buildSummary = () => {
      if (!quickFitEnabled) return "";
      const topic = getSelectedValue("topic");
      const language = getSelectedValue("language");
      const audience = getSelectedValue("audience");
      const mode = getSelectedValue("mode");
      const availability = availabilityField?.value?.trim();
      const summaryLines = [];

      if (topic) {
        const topicLabel =
          topic === "Inny język" && language ? `Inny język — ${language}` : topic;
        summaryLines.push(`Czego dotyczy: ${topicLabel}`);
      }
      if (audience) summaryLines.push(`Dla kogo są zajęcia: ${audience}`);
      if (mode) summaryLines.push(`Tryb zajęć: ${mode}`);
      if (availability) summaryLines.push(`Preferowane godziny: ${availability}`);

      return summaryLines.join("\n");
    };

    const updateSummary = () => {
      updateOtherLanguageVisibility();
      const summary = buildSummary();
      if (summaryEl) {
        summaryEl.textContent =
          summary || "Uzupełnij wybory w szybkim dopasowaniu, aby zobaczyć podsumowanie.";
      }
      if (summaryInput) summaryInput.value = summary;
      if (messageField && !messageTouched) {
        messageField.value = summary ? `${summary}\n\n` : "";
      }
      if (stepNextBtn) {
        const isOtherLanguage = getSelectedValue("topic") === "Inny język";
        const hasLanguage =
          !isOtherLanguage || Boolean(getSelectedValue("language")) || languageInputs.length === 0;
        const canAdvance =
          quickFitEnabled &&
          groupFields.every((group) => Boolean(getSelectedValue(group.name))) &&
          hasLanguage;
        stepNextBtn.disabled = !canAdvance;
      }
    };

    const primaryClasses = ["bg-primary", "text-white", "shadow-md", "hover:bg-primary-700"];
    const secondaryClasses = ["border", "border-slate-200", "bg-white", "text-slate-700", "hover:border-primary/30", "hover:text-primary"];

    const toggleQuickFitButtons = (enabled) => {
      if (quickFitOnBtn) {
        if (enabled) {
          secondaryClasses.forEach(c => quickFitOnBtn.classList.remove(c));
          primaryClasses.forEach(c => quickFitOnBtn.classList.add(c));
        } else {
          primaryClasses.forEach(c => quickFitOnBtn.classList.remove(c));
          secondaryClasses.forEach(c => quickFitOnBtn.classList.add(c));
        }
        quickFitOnBtn.setAttribute("aria-pressed", String(enabled));
      }
      if (quickFitOffBtn) {
        if (!enabled) {
          secondaryClasses.forEach(c => quickFitOffBtn.classList.remove(c));
          primaryClasses.forEach(c => quickFitOffBtn.classList.add(c));
        } else {
          primaryClasses.forEach(c => quickFitOffBtn.classList.remove(c));
          secondaryClasses.forEach(c => quickFitOffBtn.classList.add(c));
        }
        quickFitOffBtn.setAttribute("aria-pressed", String(!enabled));
      }
    };

    const setQuickFit = (enabled) => {
      quickFitEnabled = enabled;
      toggleQuickFitButtons(enabled);

      if (step1El) {
        step1El.classList.toggle("hidden", !enabled);
        step1El.setAttribute("aria-hidden", String(!enabled));
        step1El.querySelectorAll("input").forEach((input) => {
          input.disabled = !enabled;
          if (!enabled) input.checked = false;
        });
      }

      if (summaryCard) {
        summaryCard.classList.toggle("hidden", !enabled);
        summaryCard.setAttribute("aria-hidden", String(!enabled));
      }

      if (step2El) {
        if (enabled) {
          step2El.classList.add("hidden");
          step2El.setAttribute("aria-hidden", "true");
        } else {
          step2El.classList.remove("hidden");
          step2El.setAttribute("aria-hidden", "false");
        }
      }

      if (!enabled) {
        groupFields.forEach((group) => clearGroupError(group.name));
        clearGroupError("language");
      }

      updateSummary();
    };

    const revealStep2 = () => {
      if (!step2El) return;
      step2El.classList.remove("hidden");
      step2El.setAttribute("aria-hidden", "false");
      step2El.scrollIntoView({ behavior: "smooth", block: "start" });
    };

    const validate = () => {
      let firstInvalid = null;
      if (quickFitEnabled) {
        groupFields.forEach((group) => {
          clearGroupError(group.name);
          const hasValue = Boolean(getSelectedValue(group.name));
          if (!hasValue) {
            setGroupError(group.name, group.message);
            if (!firstInvalid) {
              const firstField = form?.querySelector(`input[name="${group.name}"]`);
              if (firstField) firstInvalid = firstField;
            }
          }
        });

        const isOtherLanguage = getSelectedValue("topic") === "Inny język";
        const hasLanguageOptions = languageInputs.length > 0;
        if (isOtherLanguage && hasLanguageOptions) {
          clearGroupError("language");
          if (!getSelectedValue("language")) {
            setGroupError("language", "Wybierz język.");
            if (!firstInvalid) {
              const firstField = form?.querySelector('input[name="language"]');
              if (firstField) firstInvalid = firstField;
            }
          }
        } else {
          clearGroupError("language");
        }
      } else {
        groupFields.forEach((group) => clearGroupError(group.name));
        clearGroupError("language");
      }

      fields.forEach((rule) => {
        const field = document.getElementById(rule.id);
        if (!field) return;
        clearError(field);

        const value = field.type === "checkbox" ? field.checked : field.value.trim();
        let valid = true;

        if (rule.type === "checkbox") {
          valid = Boolean(value);
        } else if (rule.type === "email") {
          valid = emailPattern.test(value);
        } else if (rule.min) {
          valid = value.length >= rule.min;
        }

        if (!valid) {
          setError(field, rule.message);
          if (!firstInvalid) firstInvalid = field;
        }
      });

      if (firstInvalid) {
        firstInvalid.focus();
      }

      return !firstInvalid;
    };

    const showAlert = (message) => {
      if (!alertEl) return;
      alertEl.textContent = message;
      alertEl.classList.remove("hidden");
      alertEl.scrollIntoView({ behavior: "smooth", block: "center" });
    };

    const clearAlert = () => {
      if (!alertEl) return;
      alertEl.textContent = "";
      alertEl.classList.add("hidden");
    };

    const setLoading = (loading) => {
      if (submitBtn) {
        submitBtn.disabled = loading;
        submitBtn.setAttribute("aria-busy", String(loading));
      }
      if (submitText) submitText.classList.toggle("hidden", loading);
      if (submitLoading) {
        submitLoading.classList.toggle("hidden", !loading);
        submitLoading.classList.toggle("inline-flex", loading);
      }
    };

    const createSuccessEl = () => {
      const wrapper = document.createElement("div");
      wrapper.id = "contact-success";
      wrapper.className =
        "mt-6 rounded-xl border border-emerald-200 bg-emerald-50 p-4 text-sm text-emerald-800";
      wrapper.setAttribute("role", "status");
      wrapper.tabIndex = -1;
      wrapper.innerHTML =
        "<strong>Dziękujemy!</strong> Twoja wiadomość została wysłana. Odezwiemy się najszybciej jak to możliwe.";
      form?.insertAdjacentElement("afterend", wrapper);
      return wrapper;
    };

    const showSuccess = () => {
      if (form) form.classList.add("hidden");
      const successEl = document.getElementById("contact-success") || createSuccessEl();
      successEl.focus();
    };

    setQuickFit(false);

    quickFitOnBtn?.addEventListener("click", () => {
      setQuickFit(true);
    });

    quickFitOffBtn?.addEventListener("click", () => {
      setQuickFit(false);
    });

    stepNextBtn?.addEventListener("click", () => {
      revealStep2();
      const nameField = document.getElementById("name");
      nameField?.focus();
    });

    form?.addEventListener("input", (event) => {
      const target = event.target;
      if (!target) return;
      clearAlert();
      if (target.id) clearError(target);
      if (target.name && groupFieldNames.has(target.name)) {
        clearGroupError(target.name);
      }
      if (target.id === "message") {
        messageTouched = true;
      }
      updateSummary();
    });

    form?.addEventListener("submit", async (event) => {
      event.preventDefault();
      clearAlert();

      if (honeypotEl?.value?.trim()) {
        showAlert("Wykryliśmy podejrzaną aktywność. Spróbuj ponownie za chwilę.");
        return;
      }

      const lastSubmit = Number(localStorage.getItem(throttleKey) || 0);
      if (Date.now() - lastSubmit < throttleMs) {
        showAlert("Prosimy odczekać minutę przed kolejną próbą wysłania formularza.");
        return;
      }

      if (messageField) {
        const summary = buildSummary();
        const userMessage = messageField.value.trim();
        if (summary && !userMessage.startsWith(summary)) {
          messageField.value = userMessage ? `${summary}\n\n${userMessage}` : summary;
        }
      }

      if (!validate()) {
        return;
      }

      setLoading(true);

      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: "POST",
          body: formData,
        });

        // Handle mailto redirect (fallback when Resend not configured)
        if (response.redirected && response.url.startsWith("mailto:")) {
          localStorage.setItem(throttleKey, String(Date.now()));
          window.location.href = response.url;
          showSuccess();
          return;
        }

        // Handle 303 redirect to mailto (for browsers that don't follow automatically)
        if (response.status === 303) {
          const mailto = response.headers.get("Location");
          if (mailto?.startsWith("mailto:")) {
            localStorage.setItem(throttleKey, String(Date.now()));
            window.location.href = mailto;
            showSuccess();
            return;
          }
        }

        const data = await response.json();

        if (!response.ok || !data.success) {
          applyFieldErrors(data.fieldErrors);
          showAlert(data.error || "Wystąpił błąd. Spróbuj ponownie.");
          return;
        }

        localStorage.setItem(throttleKey, String(Date.now()));
        showSuccess();
      } catch (error) {
        console.error("Form submission error:", error);
        showAlert("Wystąpił błąd połączenia. Sprawdź internet i spróbuj ponownie.");
      } finally {
        setLoading(false);
      }
    });
  </script>
</MainLayout>
